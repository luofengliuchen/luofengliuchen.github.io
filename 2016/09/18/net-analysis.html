<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]-->

<title>网络工程-抓包分析 | 落风的博客</title>
<meta name="author" content="落风">

  <meta name="keywords" content="抓包，fiddler，wireshark">




<link rel="shortcut icon" href="http://7xpui7.com1.z0.glb.clouddn.com/blog-site-favicon.ico" />

<link rel="stylesheet" type="text/css" href="/assets/css/style.css">

<link href="/pages/rss.xml" rel="alternate" title="落风的博客" type="application/atom+xml">
  </head>
  <body>
    <aside id="sidebar">
  <nav id="tags">
    <a href="/index.html" id="avatar" style="background-image:url(http://7xpui7.com1.z0.glb.clouddn.com/blog-site-avatar.png)"></a>

    <ul id="tags__ul">
      <li id="pl__all" class="tags__li tags-btn active">全部</li>
       
        <li id="技术" class="tags__li tags-btn">技术</li>
       
        <li id="杂说" class="tags__li tags-btn">杂说</li>
       
        <li id="小说" class="tags__li tags-btn">小说</li>
       
        <li id="照片" class="tags__li tags-btn">照片</li>
      
    </ul>

    <div id="tags__bottom">
      <a href="mailto:luofengliuchen@gmail.com" id="icon-email" class="tags-btn fontello"></a>
      <a href="/pages/rss.xml" id="icon-feed" class="tags-btn fontello"></a>
    </div>
  </nav> <!-- end #tags -->

  <div id="posts-list">
    <form action="" id="search-form">
      <a href="/index.html" id="mobile-avatar" style="background-image:url(http://7xpui7.com1.z0.glb.clouddn.com/blog-site-avatar.png)"></a>
      <!-- NOTE: input field is disabled by default -->
      <input id="search-input" type="text" placeholder="Search...">
    </form>

    <nav id="pl__container">
    
      <a class="杂说 pl__all" href="/2016/10/02/wildernessdiary-time.html"><span class="pl__circle"></span><span class="pl__title">荒原日记-时空狂想</span><span class="pl__date">Oct 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/09/18/net-analysis.html"><span class="pl__circle"></span><span class="pl__title">网络工程-抓包分析</span><span class="pl__date">Sep 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/09/15/BLocation.html"><span class="pl__circle"></span><span class="pl__title">Android基站定位</span><span class="pl__date">Sep 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/08/26/netty-point.html"><span class="pl__circle"></span><span class="pl__title">netty point</span><span class="pl__date">Aug 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/08/25/netty_connect.html"><span class="pl__circle"></span><span class="pl__title">netty框架是如何执行connect连接的</span><span class="pl__date">Aug 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/08/20/netty-beat.html"><span class="pl__circle"></span><span class="pl__title">netty自带心跳响应</span><span class="pl__date">Aug 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/08/12/AndroidSVG.html"><span class="pl__circle"></span><span class="pl__title">android svg动画</span><span class="pl__date">Aug 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/08/11/Androidstudioupdatelike.html"><span class="pl__circle"></span><span class="pl__title">AndroidStudio版本更新记录</span><span class="pl__date">Aug 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/08/05/proguard.html"><span class="pl__circle"></span><span class="pl__title">Androidstudio下的代码混淆</span><span class="pl__date">Aug 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/08/02/nine.html"><span class="pl__circle"></span><span class="pl__title">nine patch图片的用法绘制以及作用</span><span class="pl__date">Aug 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/07/22/zip.html"><span class="pl__circle"></span><span class="pl__title">Android解压缩zip文件</span><span class="pl__date">Jul 2016</span></a>
    
      <a class="杂说 pl__all" href="/2016/06/07/person.html"><span class="pl__circle"></span><span class="pl__title">程序员编程语录</span><span class="pl__date">Jun 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/04/29/sqlite.html"><span class="pl__circle"></span><span class="pl__title">Android数据库和Bean的交互</span><span class="pl__date">Apr 2016</span></a>
    
      <a class="杂说 pl__all" href="/2016/04/25/wildernessdiary-habby.html"><span class="pl__circle"></span><span class="pl__title">荒原日记-习惯</span><span class="pl__date">Apr 2016</span></a>
    
      <a class="杂说 pl__all" href="/2016/04/16/wildernessdiary-start.html"><span class="pl__circle"></span><span class="pl__title">荒原日记-开篇</span><span class="pl__date">Apr 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/02/21/studio.html"><span class="pl__circle"></span><span class="pl__title">Visual Studio开发Android程序</span><span class="pl__date">Feb 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/02/19/c++.html"><span class="pl__circle"></span><span class="pl__title">C++学习整理</span><span class="pl__date">Feb 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/02/17/socket.html"><span class="pl__circle"></span><span class="pl__title">Socket编程笔记</span><span class="pl__date">Feb 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/02/16/apk.html"><span class="pl__circle"></span><span class="pl__title">git常用命令行</span><span class="pl__date">Feb 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/02/14/apk.html"><span class="pl__circle"></span><span class="pl__title">android反编译</span><span class="pl__date">Feb 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/02/05/html5-2.html"><span class="pl__circle"></span><span class="pl__title">html5内嵌入android</span><span class="pl__date">Feb 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/02/04/html5-1.html"><span class="pl__circle"></span><span class="pl__title">HTML5绘图学习记录</span><span class="pl__date">Feb 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/02/03/html5.html"><span class="pl__circle"></span><span class="pl__title">HTML5绘图学习</span><span class="pl__date">Feb 2016</span></a>
    
      <a class="照片 pl__all" href="/2016/01/31/fox3.html"><span class="pl__circle"></span><span class="pl__title">想要冬眠的狐狸</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="照片 pl__all" href="/2016/01/31/fox2.html"><span class="pl__circle"></span><span class="pl__title">擅长卖萌的狐狸</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="照片 pl__all" href="/2016/01/31/fox1.html"><span class="pl__circle"></span><span class="pl__title">正在找东西的狐狸</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="小说 pl__all" href="/2016/01/27/dream-flower.html"><span class="pl__circle"></span><span class="pl__title">梦花</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="杂说 pl__all" href="/2016/01/27/project-mode.html"><span class="pl__circle"></span><span class="pl__title">我对瀑布开发模式和敏捷开发模式的理解</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/25/stackblur.html"><span class="pl__circle"></span><span class="pl__title">Android滤镜-快速模糊</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/18/listview-focus.html"><span class="pl__circle"></span><span class="pl__title">listview焦点冲突</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/18/android-StringPicker.html"><span class="pl__circle"></span><span class="pl__title">NumberPicker与StringPicker</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/15/draw-a-logo2.html"><span class="pl__circle"></span><span class="pl__title">Android绘图-LOGO兼容低版本</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/15/android-logo1.html"><span class="pl__circle"></span><span class="pl__title">Android绘图-LOGO-实现3</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/15/NDK.html"><span class="pl__circle"></span><span class="pl__title">Androidstudio下jni的一些问题</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/14/draw-a-logo.html"><span class="pl__circle"></span><span class="pl__title">Android绘图-LOGO-实现2</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/12/draw-a-logo.html"><span class="pl__circle"></span><span class="pl__title">Android绘图-LOGO-实现1</span><span class="pl__date">Jan 2016</span></a>
    
      <a class="技术 pl__all" href="/2016/01/11/deal-with-pix.html"><span class="pl__circle"></span><span class="pl__title">android图像处理:像素过滤</span><span class="pl__date">Jan 2016</span></a>
    
    </nav>
  </div> <!-- end #posts-list -->
</aside> <!-- end #sidebar -->
    <div id="post">
      <div id="pjax">
        <article id="post__content">
  <h1 id="post__title" data-identifier="20160918">网络工程-抓包分析</h1>
  <blockquote>
  <p>文章链接:<a href="http://www.liuschen.com">http://www.liuschen.com</a></p>
</blockquote>

<h2 id="socket">1.socket套接字</h2>
<p>socket套接字是应用层调用的传输层提供的，传输层封装Tcp/Udp协议，网际层提供ip协议的封装。所以，一般情况下，调用套接字的层序默认的协议Tcp/Udp以及ip协议，http协议可以在应用层自己定制。</p>

<h2 id="retransmission">2.Retransmission：</h2>
<p>TCP协议是一个可靠的协议。它通过重新发送(retransmission)来实现TCP片段传输的可靠性。简单的说，TCP会不断重复发送TCP片段，直到片段被正确接收。</p>

<h2 id="section">3.协议：</h2>

<pre><code>* 网际层协议：包括：IP协议、ICMP协议（Ping）、ARP协议(用于广播发现)、RARP协议。
* 传输层协议：TCP协议、UDP协议。
* 应用层协议：FTP、Telnet、SMTP、HTTP、RIP、NFS、DNS
</code></pre>

<h2 id="fiddlerwireshark">4.fiddler和wireshark</h2>
<p>fiddler可以监听抓取手机发送的包，是因为它本身具有<strong>代理功能</strong>，手机通过这个代理的端口上网，fiddler监听这个代理端口从而抓取到手机的网络数据包，并且<strong>修改完监听的端口一定要重启应用才能生效</strong>。wireshark则没有代理功能。所以单纯修改手机代理为同一局域网内电脑地址，并设置端口，在电脑中用wireshark虽然能抓到该端口有数据包，但是这些数据包是不能发送出去的，也就是说手机设置代理后是上不了网的，因为wireshark只负责抓包，没有代理功能。</p>

<h2 id="section-1">5.数据包类型含义：</h2>

<p>SYN表示建立连接，</p>

<p>FIN表示关闭连接，</p>

<p>ACK表示响应，</p>

<p>PSH表示有 DATA数据传输，</p>

<p>RST表示连接重置。</p>

<h2 id="tcp-spurious-retransmission">6.tcp spurious retransmission：</h2>

<h3 id="tcp">tcp虚假重传</h3>

<p>指实际上并没有超时，但看起来超时了，导致虚假超时重传的原因有很多种：</p>

<ol>
  <li>对于部分移动网络，当网络发生切换时会导致网络延时突增</li>
  <li>当网络的可用带宽突然变小时，网络rtt会出现突增的情况，这会导致虚假超时重传</li>
  <li>网络丢包（原始和重传的包都有可能丢包）会导致虚假重传超时。</li>
</ol>

<h2 id="wireshark">7.wireshark捕获的包：</h2>

<ol>
  <li>
    <p>Frame：物理层的数据帧概况。</p>
  </li>
  <li>
    <p>Ethernet II：数据链路层以太网帧头部信息。</p>
  </li>
  <li>
    <p>Internet Protocol Version 4：互联网层IP包头部信息。</p>
  </li>
  <li>
    <p>Transmission Control Protocol：传输层的数据段头部信息，此处是TCP协议。</p>
  </li>
  <li>
    <p>Hypertext Transfer Protocol：应用层的信息，此处是HTTP协议。</p>
  </li>
</ol>

<h2 id="socketwireshark">8.socket通过wireshark捕获的包示例</h2>
<p>通过socket正常建立tcp连接时，会先通过握手，然后发送消息，当找不到服务器时，会收到一个重置连接的包</p>

<h3 id="section-2">正常连接的包</h3>
<p><img src="http://7xpui7.com1.z0.glb.clouddn.com/blog_wireshark_socket.png" alt="正常连接情况" /></p>

<h3 id="section-3">对应端口没有开服务，会直接被拒绝</h3>
<p><img src="http://7xpui7.com1.z0.glb.clouddn.com/blog_wireshark_disconnect.png" alt="找不到服务器" /></p>

<h3 id="section-4">找不到服务器(地址)</h3>
<p><img src="http://7xpui7.com1.z0.glb.clouddn.com/not-find-server.png" alt="" /></p>

<h3 id="finackclosewaitfinackfinackclosewait">正常关闭(客户端发送关闭连接的包FIN_ACK,服务端收到后做相应关闭处理(参见下文CLOSE_WAIT)，然后发送FIN_ACK做最后确认,如果只有一个FIN_ACK包，就是服务端停在了CLOSE_WAIT状态，最后会发现保持了大量的连接)</h3>
<p><img src="http://7xpui7.com1.z0.glb.clouddn.com/close-normal.png" alt="" /></p>

<h3 id="section-5">异常关闭</h3>
<p><img src="http://7xpui7.com1.z0.glb.clouddn.com/close-error.png" alt="" /></p>

<h2 id="netstat">9.通过netstat命令得到的信息：</h2>

<blockquote>
  <p><a href="http://blog.csdn.net/kobejayandy/article/details/17655739">引用出处</a></p>
</blockquote>

<p>常用的三个状态是：</p>

<ul>
  <li>ESTABLISHED 表示正在通信，</li>
  <li>TIME_WAIT 表示主动关闭，</li>
  <li>CLOSE_WAIT 表示被动关闭。</li>
</ul>

<p>TCP协议规定，对于已经建立的连接，网络双方要进行四次握手才能成功断开连接，如果缺少了其中某个步骤，将会使连接处于假死状态，连接本身占用的资源不会被释放。网络服务器程序要同时管理大量连接，所以很有必要保证无用连接完全断开，否则大量僵死的连接会浪费许多服务器资源。在众多TCP状态中，最值得注意的状态有两个：CLOSE_WAIT和TIME_WAIT。</p>

<h3 id="timewait">TIME_WAIT</h3>

<p>TIME_WAIT 是主动关闭链接时形成的，等待2MSL时间，约4分钟。主要是防止最后一个ACK丢失。  由于TIME_WAIT 的时间会非常长，因此server端应尽量减少主动关闭连接</p>

<h3 id="closewait">CLOSE_WAIT</h3>

<p>CLOSE_WAIT是被动关闭连接是形成的。根据TCP状态机，服务器端收到客户端发送的FIN，则按照TCP实现发送ACK，因此进入CLOSE_WAIT状态。但如果服务器端不执行close()，就不能由CLOSE_WAIT迁移到LAST_ACK，则系统中会存在很多CLOSE_WAIT状态的连接。此时，可能是系统忙于处理读、写操作，而未将已收到FIN的连接，进行close。此时，recv/read已收到FIN的连接socket，会返回0。</p>

<p>为什么需要 TIME_WAIT 状态？</p>

<p>假设最终的ACK丢失，server将重发FIN，client必须维护TCP状态信息以便可以重发最终的ACK，否则会发送RST，结果server认为发生错误。TCP实现必须可靠地终止连接的两个方向(全双工关闭)，client必须进入 TIME_WAIT 状态，因为client可能面 临重发最终ACK的情形。<br />
为什么 TIME_WAIT 状态需要保持 2MSL 这么长的时间？<br />
如果 TIME_WAIT 状态保持时间不足够长(比如小于2MSL)，第一个连接就正常终止了。第二个拥有相同相关五元组的连接出现，而第一个连接的重复报文到达，干扰了第二个连接。TCP实现必须防止某个连接的重复报文在连接终止后出现，所以让TIME_WAIT状态保持时间足够长(2MSL)，连接相应方向上的TCP报文要么完全响应完毕，要么被 丢弃。建立第二个连接的时候，不会混淆。<br />
 TIME_WAIT 和CLOSE_WAIT状态socket过多</p>

<p>如果服务器出了异常，百分之八九十都是下面两种情况：<br />
1.服务器保持了大量TIME_WAIT状态<br />
2.服务器保持了大量CLOSE_WAIT状态，简单来说CLOSE_WAIT数目过大是由于被动关闭连接处理不当导致的。</p>

<h2 id="tcp-window-full">10.TCP Window Full</h2>

<p>tcp滑动窗口接收达到上限，此时会在响应包中告诉发送端，自己窗口达到上限，发送端就不再发送消息。</p>

<h3 id="wiresharkwin">通过wireshark捕获的包,每条包信息后面的win就是本机向对方告知的本机接收窗口大小</h3>
<p><img src="http://7xpui7.com1.z0.glb.clouddn.com/tcp-window-full.png" alt="" /></p>

<h3 id="section-6">单个包详情</h3>
<p><img src="http://7xpui7.com1.z0.glb.clouddn.com/tcp-window-full-details.png" alt="" /></p>

<h3 id="section-7">糊涂窗口综合症</h3>
<p><img src="http://7xpui7.com1.z0.glb.clouddn.com/tcp-window-full-pic.jpg" alt="" /></p>

<p>我这里遇到的问题是客户端向服务端发送包，服务端没有从滑动窗口及时取出数据，导致服务端接收窗口不断减小，从服务端TCP发回的响应信息就可以看出。最终，服务端接收窗口为零。客户端被告知服务端接收窗口为零，于是向服务端发送TCP window Full包，标志客户端不再发送正常数据包，开始进入零窗口探测模式，隔一段时间发送一个TCP ZerowindowProbe包，进行探测服务端是否能接收数据。</p>

<p>参考资料:</p>

<ul>
  <li><a href="http://www.cnblogs.com/awpatp/archive/2013/02/17/2914152.html">什么是TCP Window</a></li>
  <li><a href="http://www.cnblogs.com/olartan/p/4268269.html">Windows系统下的TCP参数优化</a></li>
  <li><a href="http://www.cnblogs.com/woaiyy/p/3554182.html">TCP窗口滑动以及拥塞控制1</a></li>
  <li><a href="http://blog.chinaunix.net/uid-26548237-id-3966297.html">TCP的流量控制与拥塞控制2</a></li>
</ul>

</article> <!-- end #post__content -->

<div id="post__share">
  <a id="icon-twitter" class="fontello" href="https://twitter.com/intent/tweet?url=http://www.liuschen.com/2016/09/18/net-analysis.html&text=网络工程-抓包分析" target="_blank"></a>
  <a id="icon-cc" class="fontello" href="http://creativecommons.org/licenses/by-nc-sa/3.0" target="_blank"></a>
  <a id="icon-weibo" class="fontello" href="http://v.t.sina.com.cn/share/share.php?url=http://www.liuschen.com/2016/09/18/net-analysis.html&title=网络工程-抓包分析" target="_blank"></a>
</div> <!-- end #post__share -->
<div id="disqus_thread" name="luofeng">
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink" target="_blank">Loading Disqus comments...</a>
</div>

<!-- <div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//luofeng.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> -->


        <p id="copyright">Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;&nbsp;|&nbsp;&nbsp;Theme <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll</a>&nbsp;&nbsp;|&nbsp;&nbsp;Hosted on <a href="https://pages.github.com" target="_blank">Github</a></p>
      </div> <!-- end #pjax -->

      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">Table of Contents</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
    </div> <!-- end #post -->

    <button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>

<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/jquery.pjax.js"></script>
<script src="/assets/js/nprogress.js"></script>
<script src="/assets/js/script.js"></script>
  </body>
</html>